{% extends 'base.html.twig' %}

{% block title %}{% if 'ROLE_ADMIN' in app.user.roles|default([]) %}Toutes les réservations{% else %}Mes réservations{% endif %} - MarokiCars{% endblock %}

{% block body %}
<!-- Page Header -->
<section style="background: var(--dark-gradient); padding: 4rem 0 3rem; position: relative; overflow: hidden;">
    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, rgba(102,126,234,0.2) 0%, transparent 50%), radial-gradient(circle at 80% 50%, rgba(56,239,125,0.15) 0%, transparent 50%);"></div>
    <div class="container position-relative" style="z-index: 1;">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb mb-0" style="background: transparent;">
                        <li class="breadcrumb-item">
                            <a href="{{ path('home') }}" class="text-decoration-none" style="color: rgba(255,255,255,0.7);">
                                <i class="bi bi-house-door me-1"></i>Accueil
                            </a>
                        </li>
                        <li class="breadcrumb-item active" style="color: white;">
                            {% if 'ROLE_ADMIN' in app.user.roles|default([]) %}Toutes les réservations{% else %}Mes réservations{% endif %}
                        </li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mb-3" style="color: white;">
                    <i class="bi bi-calendar-check me-3" style="color: #38ef7d;"></i>
                    {% if 'ROLE_ADMIN' in app.user.roles|default([]) %}Toutes les réservations{% else %}Mes réservations{% endif %}
                </h1>
                <p class="lead mb-0" style="color: rgba(255,255,255,0.8);">
                    {% if 'ROLE_ADMIN' in app.user.roles|default([]) %}
                        Gérez toutes les réservations de vos clients
                    {% else %}
                        Consultez et gérez vos réservations de véhicules
                    {% endif %}
                </p>
            </div>
            <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                {% if 'ROLE_CLIENT' in app.user.roles|default([]) %}
                    <a href="{{ path('app_reservation_new') }}" class="btn btn-light btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>Nouvelle réservation
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<section class="container py-5">
    <!-- Stats Cards -->
    {% if reservations|length > 0 %}
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.1) 100%); border: 1px solid rgba(17, 153, 142, 0.2);">
                <div class="card-body p-4 d-flex align-items-center gap-4">
                    <div style="width: 60px; height: 60px; background: var(--success-gradient); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-check-circle-fill text-white" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ reservations|filter(r => r.statut == 'confirmee')|length }}</h3>
                        <span class="text-muted">Confirmées</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, rgba(247, 151, 30, 0.1) 0%, rgba(255, 210, 0, 0.1) 100%); border: 1px solid rgba(247, 151, 30, 0.2);">
                <div class="card-body p-4 d-flex align-items-center gap-4">
                    <div style="width: 60px; height: 60px; background: var(--warning-gradient); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-clock-fill" style="font-size: 1.5rem; color: #1a1a2e;"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ reservations|filter(r => r.statut == 'en_attente')|length }}</h3>
                        <span class="text-muted">En attente</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid rgba(102, 126, 234, 0.2);">
                <div class="card-body p-4 d-flex align-items-center gap-4">
                    <div style="width: 60px; height: 60px; background: var(--primary-gradient); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-calendar-check-fill text-white" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ reservations|length }}</h3>
                        <span class="text-muted">Total</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if reservations|length > 0 %}
        <div class="row g-4">
            {% for reservation in reservations %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <!-- Header with Status -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center gap-3">
                                    {% if reservation.voiture.photoPrincipale %}
                                        <img src="{{ reservation.voiture.photoPrincipale }}" alt="{{ reservation.voiture.marque }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: var(--radius-sm);">
                                    {% else %}
                                        <div style="width: 50px; height: 50px; background: var(--bg-secondary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                                            <i class="bi bi-car-front" style="color: var(--text-muted);"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <h5 class="card-title mb-0">{{ reservation.voiture.marque }} {{ reservation.voiture.modele }}</h5>
                                        <span class="text-muted small">{{ reservation.voiture.annee }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <span class="badge bg-{{ reservation.statut == 'confirmee' ? 'success' : (reservation.statut == 'annulee' ? 'danger' : 'warning') }}">
                                    <i class="bi bi-{{ reservation.statut == 'confirmee' ? 'check-circle' : (reservation.statut == 'annulee' ? 'x-circle' : 'clock') }} me-1"></i>
                                    {{ reservation.statut|replace({'_': ' '})|title }}
                                </span>
                            </div>
                            
                            <!-- Dates -->
                            <div class="mb-4 p-3" style="background: var(--bg-secondary); border-radius: var(--radius-md);">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="small text-muted mb-1">
                                            <i class="bi bi-calendar-event me-1"></i>Début
                                        </div>
                                        <div class="fw-bold">{{ reservation.dateDebut|date('d/m/Y') }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small text-muted mb-1">
                                            <i class="bi bi-calendar-check me-1"></i>Fin
                                        </div>
                                        <div class="fw-bold">{{ reservation.dateFin|date('d/m/Y') }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if 'ROLE_ADMIN' in app.user.roles|default([]) %}
                                <div class="mb-3">
                                    <div class="small text-muted mb-1">
                                        <i class="bi bi-person me-1"></i>Client
                                    </div>
                                    <div class="fw-600">{{ reservation.client.nom }}</div>
                                </div>
                            {% endif %}
                            
                            {# Price & Actions #}
                            <div class="d-flex justify-content-between align-items-center pt-3" style="border-top: 1px solid #eef2ff;">
                                <h4 class="mb-0 fw-bold gradient-text">{{ reservation.montant }} <span class="text-muted small" style="background: none; -webkit-text-fill-color: var(--text-muted);">MAD</span></h4>
                                <div class="d-flex gap-2">
                                    <a href="{{ path('app_reservation_show', {'id': reservation.id}) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if reservation.statut == 'en_attente' %}
                                        <a href="{{ path('app_reservation_edit', {'id': reservation.id}) }}" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    {% endif %}
                                    {% if 'ROLE_ADMIN' in app.user.roles|default([]) and reservation.statut == 'en_attente' %}
                                        <form method="post" action="{{ path('app_reservation_confirm', {'id': reservation.id}) }}" style="display: inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('confirm' ~ reservation.id) }}">
                                            <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Êtes-vous sûr de vouloir confirmer cette réservation ?');">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                    {% if reservation.statut == 'confirmee' %}
                                        <form method="post" action="{{ path('app_reservation_cancel', {'id': reservation.id}) }}" style="display: inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ reservation.id) }}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Êtes-vous sûr de vouloir annuler cette réservation confirmée ?');">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card text-center py-5">
            <div class="card-body">
                <div class="mb-4">
                    <div style="width: 100px; height: 100px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <i class="bi bi-calendar-x" style="font-size: 3rem; color: var(--text-muted);"></i>
                    </div>
                </div>
                <h4 class="fw-bold mb-2">Aucune réservation</h4>
                <p class="text-muted mb-4">Vous n'avez pas encore de réservations.</p>
                {% if 'ROLE_CLIENT' in app.user.roles|default([]) %}
                    <a href="{{ path('app_voiture_index') }}" class="btn btn-primary">
                        <i class="bi bi-car-front me-2"></i>Découvrir nos véhicules
                    </a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</section>
{% endblock %}
